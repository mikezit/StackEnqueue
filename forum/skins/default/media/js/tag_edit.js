"use strict";(function(a,d,c,b){a.fn.caret=function(e,j){var i,p,n=this[0],o=a.browser.msie;if(typeof e==="object"&&typeof e.start==="number"&&typeof e.end==="number"){i=e.start;p=e.end}else{if(typeof e==="number"&&typeof j==="number"){i=e;p=j}else{if(typeof e==="string"){if((i=n.value.indexOf(e))>-1){p=i+e[d]}else{i=null}}else{if(Object.prototype.toString.call(e)==="[object RegExp]"){e=e.exec(n.value);if(e!=null){i=e.index;p=i+e[0][d]}}}}}if(typeof i!="undefined"){if(o){o=this[0].createTextRange();o.collapse(true);o.moveStart("character",i);o.moveEnd("character",p-i);o.select()}else{this[0].selectionStart=i;this[0].selectionEnd=p}this[0].focus();return this}else{if(o){p=document.selection;if(this[0].tagName.toLowerCase()!="textarea"){o=this.val();i=p[c]()[b]();i.moveEnd("character",o[d]);var m=i.text==""?o[d]:o.lastIndexOf(i.text);i=p[c]()[b]();i.moveStart("character",-o[d]);var k=i.text[d]}else{i=p[c]();p=i[b]();p.moveToElementText(this[0]);p.setEndPoint("EndToEnd",i);m=p.text[d]-i.text[d];k=m+i.text[d]}}else{m=n.selectionStart;k=n.selectionEnd}i=n.value.substring(m,k);return{start:m,end:k,text:i,replace:function(f){return n.value.substring(0,m)+f+n.value.substring(k,n.value[d])}}}}})(jQuery,"length","createRange","duplicate");StackPointer.tagEditor=function(ab,c,ag){var am;if(typeof ag==="undefined"){try{am=ab.is(":focus")}catch(z){am=false}}else{am=ag}function W(){am=true}ab.bind("focus",W);if(!ab.is(":visible")){c=c||0;if(c<3){setTimeout(function(){ab.unbind("focus",W);StackPointer.tagEditor(ab,c+1,am)},300);return}else{ab.unbind("focus",W);StackPointer.debug.log("tag box is invisible, couldn't start tag editor");return}}ab.unbind("focus",W);var X=ab.innerWidth();var e=((X-40)/3)|0;var S=$("<div class='tag-editor' />").css("width",X).insertAfter(ab);ab.hide();var Y=$("<span class='post-tag'>test</span>").appendTo(S);var T=S.innerHeight();Y.remove();S.css("height",T);var aa=$("<span />").appendTo(S);var H=$("<input type='text' id='id_tags' tabIndex='0'/>").appendTo(S).val(ab.val()+" ");var al=ab.attr("tabIndex");if(al){H.attr("tabIndex",al)}var V=$("<span />").appendTo(S);var r=false;H.focus(function(){am=true;var a=StackPointer.tagEditor.requiredTags;if(a&&A()){Z(StackPointer.tagEditor.requiredTags)}});H.blur(function(){am=false;setTimeout(function(){if(!r){N();C()}},0)});ab.focus(function(){H.focus()});H.keydown(K);H.bind("keydown paste click change",function(a){setTimeout(function(){C()},0)});S.delegate(".post-tag","click",function(a){var d=$(this);if($(a.target).hasClass("delete-tag")){d.text("")}ah(d);C()});S.click(function(a){if(a.target!==this){return}ah("");C()});function ao(g,h){var j=window.tagRendererRaw(g),d=j.replace(/<(\/?)a/g,"<$1span").replace(/href='[^>]*/,""),a=$(d);if(!h){a.append('<span class="delete-tag" title="remove this tag"></span>')}return a}function b(){var a=aa.find(".post-tag").map(function(g,h){return $(h).text()}).get().join(" ");if(a.length){a+=" "}var d=V.find(".post-tag").map(function(g,h){return $(h).text()}).get().join(" ");if(d.length&&H.val().length){d=" "+d}return{text:a+H.val()+d,lengthBeforeInput:a.length}}function A(){var a=H.val();return(a===""||a===" ")&&aa.add(V).children().filter(function(){return !/^\s*$/.test($(this).text())}).length===0}function o(){var d=H.caret();if(!aa.add(V).find(".post-tag").length){return}var a=b();H.val(a.text);aa.empty();V.empty();H.caret(d.start+a.lengthBeforeInput,d.end+a.lengthBeforeInput);N()}function Q(p,d){for(var p=$.trim(p).replace(/([A-Za-z0-9])\+(?=[A-Za-z0-9])/g,"$1 "),s=p.split(/[\s|,;]+/),h=[],l=0;l<s.length;l++){var m=s[l].toLowerCase().replace(/_/g,"-"),m=m.replace(/^[#+-]+/,""),m=m.replace(/[.-]+$/,"");0<m.length&&-1==$.inArray(m,h)&&h.push(m)}return h}function C(l){if(r){return}var a;if(l){a={start:H.val().length,end:H.val().length}}else{a=H.caret()}if(a.start==-1){a.start=a.end=0}if(a.start!==a.end){o();F();return}var m=H.val().substr(0,a.start);var k=H.val().substr(a.start);var h=(m+"?").split(/[,;\s]+/);if(h[h.length-1]==="?"){h[h.length-1]=""}else{h[h.length-1]=h[h.length-1].slice(0,-1)}var p=k.split(/[,;\s]+/);var d=h.pop();var g=d.length;d+=p.shift();h=Q(h.join(" "));p=Q(p.join(" "));var j;for(j=0;j<h.length;j++){ao(h[j]).appendTo(aa)}for(j=0;j<p.length;j++){ao(p[j]).appendTo(V)}if(d!==H.val()){H.val(d)}S.find(".post-tag").filter(function(){return/^\s*$/.test($(this).text())}).remove();ab.val(b().text);if(am){H.caret(g,g);ap()}F()}function ah(g,d){var a,j;if(typeof g==="string"){j=g}else{if(!g.length){return}else{a=g;j=a.text()}}ao(H.val()).appendTo(aa);H.val(j);if(a){var h=$($.unique(a.prevAll(".post-tag").get()));a.nextAll(".post-tag").prependTo(V);h.appendTo(aa);a.remove()}else{V.find(".post-tag").appendTo(aa)}H.focus();if(d){H.caret(0,0)}}var ad={};function f(g){var j=g.val(),d="c_"+j;if(d in ad){return ad[d]}var a=$("<span />").css("font-family",g.css("font-family"));a.text(g.val());a.insertAfter(g);var h=a.innerWidth();a.remove();ad[d]=h;return h}var i=0;function v(a){if(a===i){return}aa.add(H).add(V).css({position:"relative",left:a});i=a}function F(){var a=f(H)+19,d=aa.outerWidth();if(!V.children().length){a=Math.max(a,X-d-8)}H.css("width",a);if(d+i>0&&d+i+a<X){return}if(d+a<X){v(0);return}v(-d+(X-a)/2)}var aj={35:true,36:true,37:true,38:true,39:true,40:true};var q;function an(){q=true;setTimeout(function(){q=false},0)}function K(g){if((g.shiftKey&&aj[g.which])||(g.ctrlKey&&g.which===65)){o();return true}var d=H.caret().start,h=d===H.val().length,k=d===0,a,j;switch(g.which){case 37:if(!k){return true}ah(aa.find(".post-tag:last"));return false;break;case 39:if(!h){return true}ah(V.find(".post-tag:first"),true);return false;break;case 8:if(!k){return true}a=aa.find(".post-tag:last");if(!a.length){return}H.val(a.text()+H.val());H.caret(a.text().length+d);a.remove();return false;break;case 46:if(!h){return true}j=V.find(".post-tag:first");if(!j.length){return}H.val(H.val()+j.text());H.caret(d,d);j.remove();return false;break;case 36:a=aa.find(".post-tag:first");if(!a.length){return true}ah(a,true);return false;break;case 35:j=V.find(".post-tag:last");if(!j.length){return true}ah(j);return false;break;case 40:an();$(".tag-suggestions > div:first").focus();return false;break;case 9:an();break;case 27:N();break;case 13:if($(".tag-suggestions").length){return false}break}return true}var n;var u;function U(a){var d=a.find("p.more-info");if(typeof u==="undefined"){u=e-5-d.outerWidth()}var g=a.find(".post-tag:first").outerWidth()+a.find(".item-multiplier").outerWidth();if(g>u){d.find("a").text("info")}}function Z(h,j){$(".tag-suggestions").remove();r=false;var g=h.length;if(g===0){return}var a=$("<div class='tag-suggestions' />").css({position:"absolute",left:t.position().left,top:t.position().top+T+1,width:X-10}).insertAfter(t);for(var d=0;d<h.length;d++){var k=ai(h[d],j).appendTo(a).attr("tabindex",al||0);U(k);if(d%3===0){k.css("clear","both")}}a.delegate("div","keydown",ae);a.delegate("div","click",function(l){if(!$(l.target).is("a")){ak($(this))}});a.delegate("div","focus",function(){if(q&&g===1){ak($(this))}else{r=true}});a.delegate("div","blur",function(){r=false})}function ap(){var a=Q(H.val())[0];if(n===a){return}n=a;if(!(a&&a.length)){N();return}ac(a,function(d){if(a!==n||!am){return}Z(d,a)})}function ai(a,p){var m=$("<div />").css("width",e).data("tag-name",a.SynonymOf||a.Name);if(p){p=p.replace(/-/g,"").replace(/(.)(?=.)/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\.")}var d=ao(a.Name,true);var k=d.html();if(p){k=k.replace(new RegExp("("+p+")"),"<span class='match'>$1</span>")}m.append(d.html(k));if(a.Count){m.append($("<span class='item-multiplier' />").html("&times;&nbsp;"+a.Count))}var l="";if(a.Excerpt){l=a.Excerpt}if(l.length){m.append($("<p />").text(l))}if(a.Synonyms&&a.Synonyms.length){var j=$("<p >also: </p>").appendTo(m);var g=a.Synonyms.split(/\|/);for(var h=0;h<g.length;h++){l=g[h];if(p){l=l.replace(new RegExp("("+p+")"),"<span class='match'>$1</span>")}if(h>0){l=", "+l}j.append("<span>"+l+"</span>")}}m.append("<p class='more-info'><a href='/tags/"+encodeURIComponent(a.SynonymOf||a.Name)+"/info' target='_blank'>learn more</a></p>");return m}var aq={};var af=StackPointer.helpers.DelayedReaction(function(d,a){StackPointer.helpers.addSpinner(S,{position:"absolute",right:10,top:T/2-2});$.get("/filter/tags",{table_index:d,newstyle:true},"json").done(function(g){aq["t_"+d]=g;StackPointer.helpers.removeSpinner();a(g)})},400,{sliding:true});function ac(d,a){return;if(aq["t_"+d]){a(aq["t_"+d])}else{af.trigger(d,a)}}function ak(a){H.val(a.data("tag-name"));E();ah("");C()}function N(){$(".tag-suggestions").remove();r=false;af.cancel()}function ae(d){var a;switch(d.which){case 39:case 40:$(this).next("div").focus();return false;break;case 37:$(this).prev("div").focus();return false;break;case 38:a=$(this).prev("div");if(a.length){a.focus()}else{H.focus()}return false;break;case 27:N();H.focus();return false;break;case 13:case 32:ak($(this));return false;break}}C(true);StackPointer.tagEditor.ready.resolve()};StackPointer.tagEditor.ready=$.Deferred();